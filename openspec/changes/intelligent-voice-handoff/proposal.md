# Proposal: Sistema de Handoff Inteligente de Voz

## Metadata
- **Author:** Claude AI + Juliano Targa
- **Created:** 2026-01-16
- **Updated:** 2026-01-16
- **Status:** PROPOSED
- **Priority:** HIGH
- **Estimated Effort:** 9-14 dias (5 fases)
- **Multi-tenant:** ‚úÖ Sim (domain_uuid obrigat√≥rio)

## Resumo Executivo

Implementar um sistema de transfer√™ncia de chamadas inteligente onde o agente IA atua como uma **secret√°ria eletr√¥nica real**:

1. **Tenta transferir** a chamada para o destino solicitado
2. **Monitora o resultado**:
   - ‚úÖ `ANSWERED` - Atendeu, bridge completo
   - üî¥ `BUSY` - Ramal ocupado em outra chamada
   - ‚è∞ `NO_ANSWER` - N√£o atendeu (timeout)
   - üö´ `DND` - Do Not Disturb ativado
   - üì¥ `OFFLINE` - Ramal n√£o registrado/sem conex√£o
   - ‚ùå `REJECTED` - Chamada rejeitada manualmente
3. **Retorna ao cliente** informando o status com mensagem contextual
4. **Cria ticket/recado** apenas quando n√£o h√° atendimento dispon√≠vel

## Problema Atual

Atualmente, quando o cliente pede para falar com um atendente:
- ‚ùå O agente cria um ticket imediatamente
- ‚ùå N√£o tenta transferir a chamada
- ‚ùå O ticket fica vazio (sem √°udio, sem contexto √∫til)
- ‚ùå O cliente √© abandonado sem resolu√ß√£o

## Solu√ß√£o Proposta

### Fluxo Principal

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    FLUXO DE SECRET√ÅRIA INTELIGENTE                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                         ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                        ‚îÇ
‚îÇ  ‚îÇ Cliente Liga‚îÇ                                                        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                        ‚îÇ
‚îÇ         ‚ñº                                                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                            ‚îÇ
‚îÇ  ‚îÇ Agente IA Atende        ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ  ‚îÇ (Grava√ß√£o inicia)       ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ            ‚îÇ
‚îÇ         ‚ñº                                                  ‚îÇ            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ Conversa Normal         ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ            ‚îÇ
‚îÇ         ‚ñº                                                  ‚îÇ            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    N√ÉO                        ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ Cliente quer falar      ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Continua conversa   ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ com atendente?          ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ            ‚îÇ
‚îÇ         ‚îÇ SIM                                              ‚îÇ            ‚îÇ
‚îÇ         ‚ñº                                                  ‚îÇ            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ Identificar Destino     ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ - "algu√©m" ‚Üí Fila       ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ - "Jeni" ‚Üí Ramal 1004   ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ - "financeiro" ‚Üí 1004   ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ            ‚îÇ
‚îÇ         ‚ñº                                                  ‚îÇ            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ "Um momento, vou        ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ  transferir..."         ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ            ‚îÇ
‚îÇ         ‚ñº                                                  ‚îÇ            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ FreeSWITCH toca o ramal ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îÇ (Attended Transfer)     ‚îÇ                               ‚îÇ            ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               ‚îÇ            ‚îÇ
‚îÇ         ‚îÇ                                                  ‚îÇ            ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ            ‚îÇ
‚îÇ    ‚ñº         ‚ñº        ‚ñº        ‚ñº        ‚ñº        ‚ñº         ‚îÇ            ‚îÇ
‚îÇ ANSWERED  BUSY    NO_ANSWER   DND    OFFLINE  REJECTED     ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ         ‚îÇ        ‚îÇ        ‚îÇ        ‚îÇ        ‚îÇ         ‚îÇ            ‚îÇ
‚îÇ    ‚ñº         ‚ñº        ‚ñº        ‚ñº        ‚ñº        ‚ñº         ‚îÇ            ‚îÇ
‚îÇ Bridge   "Ramal   "N√£o est√° "Ramal em "Ramal   "Chamada    ‚îÇ            ‚îÇ
‚îÇ OK ‚úÖ    ocupado" atendendo" modo n√£o  offline" recusada"  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ         ‚îÇ        ‚îÇ      perturbe"    ‚îÇ        ‚îÇ       ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ         ‚îÇ        ‚îÇ        ‚îÇ        ‚îÇ        ‚îÇ         ‚îÇ            ‚îÇ
‚îÇ    ‚ñº         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ                          ‚îÇ                            ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ               ‚ñº                                       ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                        ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ "Quer deixar recado?"   ‚îÇ                        ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                        ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ           ‚îÇ                                           ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                     ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚ñº           ‚ñº                                     ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    SIM         N√ÉO                                    ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ           ‚îÇ                                     ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ           ‚ñº                                     ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îÇ "Tudo bem! Obrigada     ‚îÇ                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îÇ  pela liga√ß√£o. Tchau!"  ‚îÇ                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ           ‚ñº                                     ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îÇ DESLIGA CHAMADA         ‚îÇ                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îÇ (sem criar ticket)      ‚îÇ                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚îÇ                                                 ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ     ‚ñº                                                 ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ "Pode falar que eu vou  ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ  anotar e encaminhar."  ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ          ‚ñº                                            ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ CLIENTE FALA O RECADO   ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ (agente escuta)         ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ          ‚ñº                                            ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ Detecta sil√™ncio        ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ (cliente parou)         ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ          ‚ñº                                            ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ "Anotado! Posso ajudar  ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îÇ  em mais alguma coisa?" ‚îÇ                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ          ‚îÇ                                            ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                      ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚ñº           ‚ñº                                      ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ   SIM         N√ÉO / "Era s√≥ isso"                     ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ           ‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ           ‚ñº                                      ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ "Perfeito! Seu recado   ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ  foi registrado. Vamos  ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ  retornar em breve.     ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ  Obrigada! Tchau!"      ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ           ‚ñº                                      ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ CRIAR TICKET/RECADO     ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ - √Åudio da conversa     ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ - Transcri√ß√£o           ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ - Resumo                ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ - Destino pretendido    ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ           ‚ñº                                      ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îÇ DESLIGA CHAMADA         ‚îÇ                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îÇ                                                  ‚îÇ            ‚îÇ
‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
‚îÇ    ‚îÇ                                                                    ‚îÇ
‚îÇ    ‚ñº                                                                    ‚îÇ
‚îÇ Agente IA desconecta                                                    ‚îÇ
‚îÇ (Bridge entre cliente e atendente humano)                               ‚îÇ
‚îÇ                                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Componentes Necess√°rios

#### 0. Sistema de Callback Inteligente (NOVO)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SISTEMA DE CALLBACK INTELIGENTE                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 1: OFERTA DE CALLBACK                                                ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Ramal OCUPADO / INDISPON√çVEL / TIMEOUT                                     ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ         ‚ñº                                                                   ‚îÇ
‚îÇ  Agente: "O ramal da Jeni est√° ocupado. Posso pedir para ela                ‚îÇ
‚îÇ           retornar sua liga√ß√£o assim que estiver dispon√≠vel?"               ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                              ‚îÇ
‚îÇ    ‚ñº         ‚ñº                                                              ‚îÇ
‚îÇ   SIM       N√ÉO ‚Üí Fluxo de recado normal                                    ‚îÇ
‚îÇ    ‚îÇ                                                                        ‚îÇ
‚îÇ    ‚ñº                                                                        ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 2: CAPTURA DO N√öMERO (Inteligente)                                   ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Agente: "Qual n√∫mero ela deve ligar?"                                      ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                      ‚îÇ
‚îÇ    ‚ñº                                 ‚ñº                                      ‚îÇ
‚îÇ  "Este mesmo"                    "Outro: 99888-7777"                        ‚îÇ
‚îÇ  "Esse n√∫mero"                        ‚îÇ                                     ‚îÇ
‚îÇ  "O que t√¥ ligando"                   ‚îÇ                                     ‚îÇ
‚îÇ    ‚îÇ                                  ‚îÇ                                     ‚îÇ
‚îÇ    ‚ñº                                  ‚îÇ                                     ‚îÇ
‚îÇ  Usar caller_id autom√°tico            ‚îÇ                                     ‚îÇ
‚îÇ    ‚îÇ                                  ‚îÇ                                     ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                     ‚îÇ
‚îÇ                   ‚ñº                                                         ‚îÇ
‚îÇ  Agente: "Vou anotar para retornar no 18 99775-1234. Est√° correto?"         ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                              ‚îÇ
‚îÇ    ‚ñº         ‚ñº                                                              ‚îÇ
‚îÇ   SIM       N√ÉO ‚Üí Pede n√∫mero novamente                                     ‚îÇ
‚îÇ    ‚îÇ                                                                        ‚îÇ
‚îÇ    ‚ñº                                                                        ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 3: HOR√ÅRIO DO RETORNO (Opcional)                                     ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Agente: "Prefere que ligue agora que ela estiver livre,                    ‚îÇ
‚îÇ           ou em um hor√°rio espec√≠fico?"                                     ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                      ‚îÇ
‚îÇ    ‚ñº                                 ‚ñº                                      ‚îÇ
‚îÇ  "Agora mesmo"               "√Äs 14h" / "Mais tarde"                        ‚îÇ
‚îÇ  "Assim que puder"                   ‚îÇ                                      ‚îÇ
‚îÇ    ‚îÇ                                 ‚îÇ                                      ‚îÇ
‚îÇ    ‚ñº                                 ‚ñº                                      ‚îÇ
‚îÇ  callback.scheduledAt = null    callback.scheduledAt = "14:00"              ‚îÇ
‚îÇ    ‚îÇ                                 ‚îÇ                                      ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                      ‚îÇ
‚îÇ                   ‚ñº                                                         ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 4: CONTEXTO DO ASSUNTO                                               ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Agente: "Para ela j√° saber o assunto, pode me dizer                        ‚îÇ
‚îÇ           brevemente o motivo do contato?"                                  ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ         ‚ñº                                                                   ‚îÇ
‚îÇ  Cliente: "√â sobre o boleto que venceu"                                     ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ         ‚ñº                                                                   ‚îÇ
‚îÇ  callback.reason = "Boleto vencido"                                         ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 5: CONFIRMA√á√ÉO + OPCIONAL SMS/WHATSAPP                               ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Agente: "Perfeito! A Jeni vai retornar para 18 99775-1234                  ‚îÇ
‚îÇ           assim que poss√≠vel. Deseja receber uma confirma√ß√£o                ‚îÇ
‚îÇ           por WhatsApp quando ela estiver pronta para ligar?"               ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                              ‚îÇ
‚îÇ    ‚ñº         ‚ñº                                                              ‚îÇ
‚îÇ   SIM       N√ÉO                                                             ‚îÇ
‚îÇ    ‚îÇ         ‚îÇ                                                              ‚îÇ
‚îÇ    ‚ñº         ‚îÇ                                                              ‚îÇ
‚îÇ  Enviar msg ‚îÇ                                                               ‚îÇ
‚îÇ  WhatsApp   ‚îÇ                                                               ‚îÇ
‚îÇ    ‚îÇ         ‚îÇ                                                              ‚îÇ
‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                              ‚îÇ
‚îÇ         ‚ñº                                                                   ‚îÇ
‚îÇ  Agente: "Anotado! Obrigada pela liga√ß√£o. Tchau!"                           ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ         ‚ñº                                                                   ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 6: CRIAR TICKET CALLBACK                                             ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ  TICKET COM FLAG CALLBACK                                      ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ticketType = "callback"                                 ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  status = "pending"                                      ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  priority = "high" (callback √© urgente)                  ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ                                                          ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackNumber = "5518997751234"                        ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackIntendedFor = user_id (Jeni)                    ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackExtension = "1004"                              ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackScheduledAt = null ou "2026-01-16 14:00"        ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackReason = "Boleto vencido"                       ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackAttempts = 0                                    ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackMaxAttempts = 3                                 ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  callbackNotifyViaWhatsApp = true                        ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ                                                          ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  + √Åudio da conversa original                            ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  + Transcri√ß√£o                                           ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  + Resumo                                                ‚îÇ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ         ‚ñº                                                                   ‚îÇ
‚îÇ  DESLIGA CHAMADA                                                            ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 7: DETEC√á√ÉO DE DISPONIBILIDADE                                       ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ  WORKER MONITORA CALLBACKS PENDENTES                           ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  A cada 30 segundos:                                           ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  1. Buscar tickets com ticketType = "callback" AND             ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ     status = "pending" AND callbackIntendedFor = X             ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  2. Verificar se ramal X est√° dispon√≠vel via FreeSWITCH        ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ     (ESL: show channels / sofia status)                        ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  3. Se dispon√≠vel E (scheduledAt is null OR now >= scheduledAt)‚îÇ        ‚îÇ
‚îÇ  ‚îÇ     ‚Üí Notificar atendente                                      ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 8: ALERTA NO OMNIPLAY                                                ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ  üîî CALLBACK ALERT - DESKTOP/MOBILE                            ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  üîî Callback Pendente!                              ‚è∞  ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ                                                        ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  üìû Cliente: 18 99775-1234                             ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚è±Ô∏è  Solicitado h√°: 5 minutos                          ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  üìù Assunto: "Boleto vencido"                          ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ                                                        ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  üí¨ Transcri√ß√£o dispon√≠vel                             ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  üéß √Åudio: [‚ñ∂Ô∏è Ouvir conversa original]                ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ                                                        ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ [üìû Ligar Agora]   [‚è∞ 5min]   [‚ùå Dispensar]    ‚îÇ  ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  CARACTER√çSTICAS:                                              ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  - Notifica√ß√£o push (mobile)                                   ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  - Som de alerta                                               ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  - Badge no √≠cone (contador)                                   ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  - Toast/Snackbar persistente                                  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  - Atalho de teclado para ligar                                ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 9: EXECU√á√ÉO DO CALLBACK                                              ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Jeni clica em [üìû Ligar Agora]                                             ‚îÇ
‚îÇ         ‚îÇ                                                                   ‚îÇ
‚îÇ         ‚ñº                                                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ  ORIGINA√á√ÉO AUTOM√ÅTICA (Click-to-Call)                         ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  1. FreeSWITCH origina chamada para ramal 1004 (Jeni)          ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  2. Jeni atende seu telefone                                   ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  3. Sistema toca mensagem:                                     ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ     "Callback para cliente 18 99775-1234.                      ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ      Assunto: boleto vencido. Conectando..."                   ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  4. FreeSWITCH disca para 18 99775-1234                        ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  5. Cliente atende ‚Üí Bridge: Jeni ‚Üî Cliente                    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                              ‚îÇ                                              ‚îÇ
‚îÇ         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                         ‚îÇ
‚îÇ         ‚ñº                    ‚ñº                    ‚ñº                         ‚îÇ
‚îÇ    ATENDEU              N√ÉO ATENDEU          OCUPADO/ERRO                   ‚îÇ
‚îÇ         ‚îÇ                    ‚îÇ                    ‚îÇ                         ‚îÇ
‚îÇ         ‚ñº                    ‚ñº                    ‚ñº                         ‚îÇ
‚îÇ   Ticket ‚Üí            Incrementar         Tentar novamente                  ‚îÇ
‚îÇ   status: "open"      attempts            em 5 minutos                      ‚îÇ
‚îÇ         ‚îÇ                    ‚îÇ                    ‚îÇ                         ‚îÇ
‚îÇ         ‚îÇ                    ‚ñº                    ‚îÇ                         ‚îÇ
‚îÇ         ‚îÇ            Se attempts >= 3:            ‚îÇ                         ‚îÇ
‚îÇ         ‚îÇ            ‚Üí Notificar via WhatsApp     ‚îÇ                         ‚îÇ
‚îÇ         ‚îÇ            ‚Üí Marcar como "failed"       ‚îÇ                         ‚îÇ
‚îÇ         ‚îÇ                                         ‚îÇ                         ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                         ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ  FASE 10: NOTIFICA√á√ÉO WHATSAPP (Opcional)                                  ‚îÇ
‚îÇ  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Se cliente optou por receber confirma√ß√£o:                                  ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ  üì± WHATSAPP DO CLIENTE                                        ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ  "Ol√°! Aqui √© da Internet Play. üìû                             ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ   A Jeni do Financeiro est√° pronta para retornar sua           ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ   liga√ß√£o sobre o boleto.                                      ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ   Podemos ligar agora?                                         ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ   [‚úÖ Sim, podem ligar]  [‚è∞ Depois]  [‚ùå N√£o precisa mais]"    ‚îÇ        ‚îÇ
‚îÇ  ‚îÇ                                                                ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  Se cliente responder "Sim" ‚Üí Iniciar callback                              ‚îÇ
‚îÇ  Se cliente responder "Depois" ‚Üí Perguntar hor√°rio                          ‚îÇ
‚îÇ  Se cliente responder "N√£o precisa" ‚Üí Fechar ticket                         ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### 1. Tabela de Destinos de Transfer√™ncia (FusionPBX)
```sql
CREATE TABLE v_voice_transfer_destinations (
    transfer_destination_uuid UUID PRIMARY KEY,
    domain_uuid UUID NOT NULL,
    secretary_uuid UUID REFERENCES v_voice_secretaries,
    
    -- Identifica√ß√£o por voz/texto
    name VARCHAR(100) NOT NULL,           -- "Jeni", "financeiro", "suporte"
    aliases TEXT[],                        -- ["jeni", "jeniffer", "financeiro"]
    
    -- Destino FreeSWITCH
    destination_type VARCHAR(20),          -- extension, queue, ring_group, external
    destination_number VARCHAR(50),        -- 1004, 5001, 9000
    destination_context VARCHAR(50),       -- default, public
    
    -- Configura√ß√µes
    ring_timeout_seconds INT DEFAULT 30,
    fallback_action VARCHAR(20),           -- voicemail, ticket, retry, hangup
    
    -- Metadados
    department VARCHAR(100),               -- "Financeiro", "Suporte"
    description TEXT,
    
    is_enabled BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. L√≥gica de Transfer√™ncia (FreeSWITCH + ESL)

**Estados de Resultado e Detec√ß√£o:**

| Estado | SIP Response | FreeSWITCH Cause | Mensagem do Agente IA |
|--------|--------------|------------------|----------------------|
| `ANSWERED` | 200 OK | `NORMAL_CLEARING` | *(bridge completo, IA desconecta)* |
| `BUSY` | 486 Busy Here | `USER_BUSY` | "O ramal da {nome} est√° ocupado no momento." |
| `NO_ANSWER` | 408 Timeout | `NO_ANSWER` | "A {nome} n√£o est√° atendendo no momento." |
| `DND` | 480 Temporarily Unavailable | `CALL_REJECTED` + DND flag | "A {nome} est√° em modo n√£o perturbe." |
| `OFFLINE` | 480/404 | `SUBSCRIBER_ABSENT` | "O ramal da {nome} est√° offline no momento." |
| `REJECTED` | 603 Decline | `CALL_REJECTED` | "A chamada foi recusada." |

**Detec√ß√£o via ESL:**

```python
# voice-ai-service/realtime/handlers/transfer.py

TRANSFER_RESULT_MAP = {
    # SIP response ‚Üí Estado interno
    "200": "ANSWERED",
    "486": "BUSY",
    "408": "NO_ANSWER",
    "480": "OFFLINE",      # Pode ser DND tamb√©m, verificar vari√°vel
    "404": "OFFLINE",
    "603": "REJECTED",
    "487": "CANCELLED",    # Caller desligou durante ring
}

# Verificar DND separadamente
async def detect_transfer_result(call_uuid: str, esl: ESLConnection) -> str:
    """Detecta resultado do transfer via eventos ESL."""
    
    # Aguardar evento CHANNEL_HANGUP ou CHANNEL_BRIDGE
    event = await esl.wait_for_event(
        call_uuid, 
        ["CHANNEL_BRIDGE", "CHANNEL_HANGUP"],
        timeout=30
    )
    
    if event.name == "CHANNEL_BRIDGE":
        return "ANSWERED"
    
    # Analisar causa do hangup
    hangup_cause = event.get("Hangup-Cause", "NORMAL_CLEARING")
    sip_code = event.get("variable_sip_term_status", "200")
    
    # Verificar DND explicitamente
    if event.get("variable_dnd", "false") == "true":
        return "DND"
    
    # Verificar se ramal estava offline
    reg_status = event.get("variable_sofia_profile_reg_status", "")
    if reg_status == "unregistered":
        return "OFFLINE"
    
    return TRANSFER_RESULT_MAP.get(sip_code, "NO_ANSWER")
```

**Mensagens Contextuais por Estado:**

```python
# voice-ai-service/realtime/handlers/transfer_messages.py

TRANSFER_MESSAGES = {
    "BUSY": {
        "pt-BR": "O ramal {dest_name} est√° ocupado no momento. {offer_options}",
        "en-US": "The extension {dest_name} is currently busy. {offer_options}",
    },
    "NO_ANSWER": {
        "pt-BR": "{dest_name} n√£o est√° atendendo no momento. {offer_options}",
        "en-US": "{dest_name} is not answering at the moment. {offer_options}",
    },
    "DND": {
        "pt-BR": "{dest_name} est√° em modo n√£o perturbe. {offer_options}",
        "en-US": "{dest_name} has Do Not Disturb enabled. {offer_options}",
    },
    "OFFLINE": {
        "pt-BR": "O ramal {dest_name} est√° offline no momento. {offer_options}",
        "en-US": "The extension {dest_name} is currently offline. {offer_options}",
    },
    "REJECTED": {
        "pt-BR": "A chamada foi recusada. {offer_options}",
        "en-US": "The call was declined. {offer_options}",
    },
}

OFFER_OPTIONS = {
    "pt-BR": "Posso pedir para retornarem sua liga√ß√£o, ou voc√™ prefere deixar um recado?",
    "en-US": "Would you like them to call you back, or would you prefer to leave a message?",
}

def get_transfer_failed_message(
    result: str, 
    dest_name: str, 
    language: str = "pt-BR"
) -> str:
    """Gera mensagem contextual para transfer falhado."""
    template = TRANSFER_MESSAGES.get(result, TRANSFER_MESSAGES["NO_ANSWER"])
    message = template.get(language, template["pt-BR"])
    
    return message.format(
        dest_name=dest_name,
        offer_options=OFFER_OPTIONS.get(language, OFFER_OPTIONS["pt-BR"])
    )
```

- Attended transfer com monitoramento de eventos ESL
- Detec√ß√£o de 6 estados poss√≠veis (ANSWERED, BUSY, NO_ANSWER, DND, OFFLINE, REJECTED)
- Mensagens contextuais por estado e idioma
- Callback para Voice AI com resultado
- Retorno ao agente se falhar

#### 3. Grava√ß√£o de Chamada
- Gravar desde o in√≠cio
- Upload para MinIO ap√≥s handoff
- Anexar ao ticket

#### 4. Interface FusionPBX
- CRUD de destinos de transfer√™ncia
- Associa√ß√£o com secret√°rias
- Configura√ß√£o de timeouts e fallbacks

#### 5. Model Ticket Atualizado (OmniPlay)
```typescript
// backend/src/models/Ticket.ts - Novos campos para callback

// Campos existentes...

// Campos de Callback (novos)
ticketType: {
  type: DataTypes.ENUM('chat', 'voice', 'callback'),
  defaultValue: 'chat'
},
callbackNumber: {
  type: DataTypes.STRING(50),  // E.164: 5518997751234
  allowNull: true
},
callbackIntendedFor: {
  type: DataTypes.INTEGER,     // user_id do atendente destino
  allowNull: true
},
callbackExtension: {
  type: DataTypes.STRING(10),  // 1004
  allowNull: true
},
callbackDepartment: {
  type: DataTypes.STRING(100), // "Financeiro"
  allowNull: true
},
callbackScheduledAt: {
  type: DataTypes.DATE,        // null = assim que dispon√≠vel
  allowNull: true
},
callbackReason: {
  type: DataTypes.STRING(500), // "Boleto vencido"
  allowNull: true
},
callbackAttempts: {
  type: DataTypes.INTEGER,
  defaultValue: 0
},
callbackMaxAttempts: {
  type: DataTypes.INTEGER,
  defaultValue: 3
},
callbackLastAttemptAt: {
  type: DataTypes.DATE,
  allowNull: true
},
callbackNotifyViaWhatsApp: {
  type: DataTypes.BOOLEAN,
  defaultValue: false
},
callbackWhatsAppMessageId: {
  type: DataTypes.STRING(100),  // Para rastrear resposta
  allowNull: true
},
callbackStatus: {
  type: DataTypes.ENUM(
    'pending',      // Aguardando atendente ficar dispon√≠vel
    'scheduled',    // Agendado para hor√°rio espec√≠fico
    'notified',     // Atendente foi notificado
    'in_progress',  // Callback em andamento
    'completed',    // Callback realizado com sucesso
    'failed',       // Esgotou tentativas
    'canceled'      // Cliente cancelou via WhatsApp
  ),
  defaultValue: 'pending'
},
callbackPriority: {
  type: DataTypes.ENUM('normal', 'high', 'urgent'),
  defaultValue: 'high'  // Callbacks s√£o sempre prioridade
}
```

#### 6. API Click-to-Call (OmniPlay Backend)
```typescript
// backend/src/routes/voiceRoutes.ts

/**
 * POST /api/voice/callback/initiate
 * 
 * Inicia um callback manualmente quando o atendente clica em "Ligar Agora"
 * 
 * Body:
 *   ticketId: number
 *   userId: number (quem est√° iniciando)
 * 
 * Flow:
 *   1. Valida ticket √© tipo callback
 *   2. Verifica usu√°rio tem permiss√£o
 *   3. Chama FreeSWITCH via ESL para originar chamada
 *   4. Atualiza callbackStatus = 'in_progress'
 *   5. Retorna call_uuid para tracking
 */
router.post("/callback/initiate", authMiddleware, async (req, res) => {
  // ... implementa√ß√£o
});

/**
 * POST /api/voice/callback/result
 * 
 * Webhook chamado pelo Voice AI ap√≥s callback terminar
 * 
 * Body:
 *   ticketId: number
 *   callUuid: string
 *   result: 'answered' | 'no_answer' | 'busy' | 'failed'
 *   duration: number (segundos)
 * 
 * Flow:
 *   - answered: status = 'completed', abrir ticket normal
 *   - no_answer/busy: incrementar attempts, reagendar ou falhar
 *   - failed: marcar como failed, notificar WhatsApp se habilitado
 */
router.post("/callback/result", serviceAuthMiddleware, async (req, res) => {
  // ... implementa√ß√£o
});

/**
 * GET /api/voice/callback/pending
 * 
 * Lista callbacks pendentes para um atendente (para widget)
 * 
 * Query:
 *   userId?: number (se n√£o informado, retorna todos do company)
 * 
 * Returns:
 *   callbacks: Array<{
 *     ticketId, callbackNumber, callbackReason, 
 *     scheduledAt, waitingMinutes, priority
 *   }>
 */
router.get("/callback/pending", authMiddleware, async (req, res) => {
  // ... implementa√ß√£o
});
```

#### 7. Worker de Monitoramento de Callbacks
```typescript
// backend/src/jobs/CallbackMonitorJob.ts

import Bull from "bull";
import logger from "../utils/logger";
import Ticket from "../models/Ticket";
import User from "../models/User";
import { Op } from "sequelize";
import { getIO } from "../libs/socket";
import FreeSwitchService from "../services/VoiceServices/FreeSwitchService";

/**
 * CallbackMonitorJob
 * 
 * Executa a cada 30 segundos para:
 * 1. Buscar tickets com callbackStatus = 'pending' ou 'scheduled'
 * 2. Verificar se atendente destino est√° dispon√≠vel (via FreeSWITCH)
 * 3. Se dispon√≠vel + hor√°rio OK ‚Üí notificar via Socket.IO
 * 4. Atualizar callbackStatus = 'notified'
 */

const CALLBACK_MONITOR_INTERVAL_MS = 30000; // 30 segundos

export default {
  key: "CallbackMonitor",
  
  options: {
    repeat: {
      every: CALLBACK_MONITOR_INTERVAL_MS
    }
  },
  
  async handle({ data }: { data: any }) {
    const io = getIO();
    
    // Buscar callbacks pendentes
    const pendingCallbacks = await Ticket.findAll({
      where: {
        ticketType: "callback",
        callbackStatus: {
          [Op.in]: ["pending", "scheduled"]
        },
        // Scheduled: s√≥ se j√° passou o hor√°rio
        [Op.or]: [
          { callbackScheduledAt: null },
          { callbackScheduledAt: { [Op.lte]: new Date() } }
        ]
      },
      include: [
        { model: User, as: "callbackUser", required: false }
      ],
      limit: 50 // Processar em batches
    });
    
    for (const ticket of pendingCallbacks) {
      try {
        // Verificar disponibilidade do atendente via FreeSWITCH
        const isAvailable = await FreeSwitchService.checkExtensionAvailable(
          ticket.callbackExtension,
          ticket.companyId
        );
        
        if (isAvailable) {
          // Emitir evento para o atendente espec√≠fico
          io.of(String(ticket.companyId)).emit(
            `user-${ticket.callbackIntendedFor}-callback`,
            {
              action: "new_callback",
              ticket: {
                id: ticket.id,
                callbackNumber: ticket.callbackNumber,
                callbackReason: ticket.callbackReason,
                callbackDepartment: ticket.callbackDepartment,
                waitingMinutes: Math.floor(
                  (Date.now() - ticket.createdAt.getTime()) / 60000
                ),
                priority: ticket.callbackPriority,
                hasAudio: !!ticket.voiceRecordingUrl,
                hasTranscript: !!ticket.voiceTranscript
              }
            }
          );
          
          // Atualizar status
          await ticket.update({ callbackStatus: "notified" });
          
          logger.info("üìû Callback notification sent", {
            ticketId: ticket.id,
            userId: ticket.callbackIntendedFor,
            extension: ticket.callbackExtension
          });
        }
      } catch (error) {
        logger.error("Error processing callback", {
          ticketId: ticket.id,
          error: error instanceof Error ? error.message : String(error)
        });
      }
    }
  }
};
```

#### 8. Componente Frontend - Callback Alert Widget
```jsx
// frontend/src/components/CallbackAlertWidget/index.js

import React, { useState, useEffect, useCallback } from "react";
import { 
  Snackbar, 
  Card, 
  CardContent, 
  Typography, 
  Button, 
  IconButton,
  Badge,
  Fab,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  List,
  ListItem,
  ListItemText,
  ListItemSecondaryAction,
  Chip
} from "@material-ui/core";
import { 
  Phone as PhoneIcon, 
  Schedule as ScheduleIcon,
  Close as CloseIcon,
  PlayArrow as PlayIcon,
  Notifications as NotificationsIcon
} from "@material-ui/icons";
import { makeStyles } from "@material-ui/core/styles";
import { toast } from "react-toastify";
import api from "../../services/api";
import useSocket from "../../hooks/useSocket";
import useAuth from "../../hooks/useAuth";

const useStyles = makeStyles((theme) => ({
  fab: {
    position: "fixed",
    bottom: theme.spacing(10),
    right: theme.spacing(3),
    zIndex: 1300,
    animation: "$pulse 2s infinite"
  },
  "@keyframes pulse": {
    "0%": { boxShadow: "0 0 0 0 rgba(255, 152, 0, 0.7)" },
    "70%": { boxShadow: "0 0 0 15px rgba(255, 152, 0, 0)" },
    "100%": { boxShadow: "0 0 0 0 rgba(255, 152, 0, 0)" }
  },
  callbackCard: {
    minWidth: 350,
    backgroundColor: theme.palette.warning.light,
    borderLeft: `4px solid ${theme.palette.warning.dark}`
  },
  urgentCard: {
    backgroundColor: theme.palette.error.light,
    borderLeft: `4px solid ${theme.palette.error.dark}`
  },
  waitingChip: {
    marginLeft: theme.spacing(1)
  },
  actionButtons: {
    display: "flex",
    gap: theme.spacing(1),
    marginTop: theme.spacing(2)
  },
  audioButton: {
    marginTop: theme.spacing(1)
  }
}));

const CallbackAlertWidget = () => {
  const classes = useStyles();
  const { user } = useAuth();
  const socket = useSocket();
  
  const [callbacks, setCallbacks] = useState([]);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [currentAlert, setCurrentAlert] = useState(null);
  const [loading, setLoading] = useState(false);
  
  // Carregar callbacks pendentes ao iniciar
  useEffect(() => {
    const loadPendingCallbacks = async () => {
      try {
        const { data } = await api.get("/voice/callback/pending", {
          params: { userId: user.id }
        });
        setCallbacks(data.callbacks || []);
      } catch (error) {
        console.error("Error loading callbacks:", error);
      }
    };
    
    loadPendingCallbacks();
    
    // Polling a cada 30s como backup
    const interval = setInterval(loadPendingCallbacks, 30000);
    return () => clearInterval(interval);
  }, [user.id]);
  
  // Escutar eventos de socket para novos callbacks
  useEffect(() => {
    if (!socket) return;
    
    const handleNewCallback = (data) => {
      if (data.action === "new_callback") {
        // Tocar som de alerta
        const audio = new Audio("/notification_callback.mp3");
        audio.play().catch(() => {});
        
        // Adicionar √† lista
        setCallbacks(prev => {
          if (prev.find(c => c.id === data.ticket.id)) return prev;
          return [data.ticket, ...prev];
        });
        
        // Mostrar toast
        toast.warning(
          `üìû Callback pendente: ${data.ticket.callbackNumber}`,
          { autoClose: false }
        );
        
        // Mostrar alerta imediato
        setCurrentAlert(data.ticket);
      }
    };
    
    socket.on(`user-${user.id}-callback`, handleNewCallback);
    
    return () => {
      socket.off(`user-${user.id}-callback`, handleNewCallback);
    };
  }, [socket, user.id]);
  
  // Iniciar callback
  const handleInitiateCallback = async (ticketId) => {
    setLoading(true);
    try {
      await api.post("/voice/callback/initiate", { ticketId });
      toast.success("üìû Conectando chamada...");
      setCallbacks(prev => prev.filter(c => c.id !== ticketId));
      setCurrentAlert(null);
    } catch (error) {
      toast.error("Erro ao iniciar callback: " + error.message);
    } finally {
      setLoading(false);
    }
  };
  
  // Adiar callback
  const handleSnooze = async (ticketId, minutes) => {
    try {
      await api.post("/voice/callback/snooze", { ticketId, minutes });
      toast.info(`‚è∞ Callback adiado por ${minutes} minutos`);
      setCallbacks(prev => prev.filter(c => c.id !== ticketId));
      setCurrentAlert(null);
    } catch (error) {
      toast.error("Erro ao adiar callback");
    }
  };
  
  // Dispensar callback
  const handleDismiss = async (ticketId) => {
    try {
      await api.post("/voice/callback/dismiss", { ticketId });
      setCallbacks(prev => prev.filter(c => c.id !== ticketId));
      setCurrentAlert(null);
    } catch (error) {
      toast.error("Erro ao dispensar callback");
    }
  };
  
  const formatWaitingTime = (minutes) => {
    if (minutes < 60) return `${minutes}min`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h${mins > 0 ? mins + 'min' : ''}`;
  };
  
  return (
    <>
      {/* FAB com Badge */}
      {callbacks.length > 0 && (
        <Fab 
          color="secondary" 
          className={classes.fab}
          onClick={() => setDialogOpen(true)}
        >
          <Badge badgeContent={callbacks.length} color="error">
            <PhoneIcon />
          </Badge>
        </Fab>
      )}
      
      {/* Snackbar de Alerta Imediato */}
      <Snackbar
        open={!!currentAlert}
        anchorOrigin={{ vertical: "top", horizontal: "right" }}
      >
        <Card 
          className={`${classes.callbackCard} ${
            currentAlert?.priority === 'urgent' ? classes.urgentCard : ''
          }`}
        >
          <CardContent>
            <Typography variant="h6" gutterBottom>
              üîî Callback Pendente!
              <IconButton 
                size="small" 
                onClick={() => setCurrentAlert(null)}
                style={{ float: "right" }}
              >
                <CloseIcon />
              </IconButton>
            </Typography>
            
            <Typography variant="body1">
              üìû <strong>{currentAlert?.callbackNumber}</strong>
            </Typography>
            
            {currentAlert?.callbackReason && (
              <Typography variant="body2" color="textSecondary">
                üìù {currentAlert.callbackReason}
              </Typography>
            )}
            
            <Chip
              size="small"
              icon={<ScheduleIcon />}
              label={`Aguardando h√° ${formatWaitingTime(currentAlert?.waitingMinutes || 0)}`}
              className={classes.waitingChip}
              color={currentAlert?.waitingMinutes > 10 ? "secondary" : "default"}
            />
            
            {currentAlert?.hasAudio && (
              <Button
                size="small"
                startIcon={<PlayIcon />}
                className={classes.audioButton}
                onClick={() => {/* Abrir player de √°udio */}}
              >
                Ouvir conversa
              </Button>
            )}
            
            <div className={classes.actionButtons}>
              <Button
                variant="contained"
                color="primary"
                startIcon={<PhoneIcon />}
                onClick={() => handleInitiateCallback(currentAlert?.id)}
                disabled={loading}
              >
                Ligar Agora
              </Button>
              <Button
                variant="outlined"
                onClick={() => handleSnooze(currentAlert?.id, 5)}
              >
                ‚è∞ 5min
              </Button>
              <Button
                variant="text"
                color="secondary"
                onClick={() => handleDismiss(currentAlert?.id)}
              >
                Dispensar
              </Button>
            </div>
          </CardContent>
        </Card>
      </Snackbar>
      
      {/* Dialog com Lista de Callbacks */}
      <Dialog
        open={dialogOpen}
        onClose={() => setDialogOpen(false)}
        maxWidth="sm"
        fullWidth
      >
        <DialogTitle>
          üìû Callbacks Pendentes ({callbacks.length})
        </DialogTitle>
        <DialogContent>
          <List>
            {callbacks.map((callback) => (
              <ListItem key={callback.id} divider>
                <ListItemText
                  primary={
                    <>
                      {callback.callbackNumber}
                      <Chip
                        size="small"
                        label={formatWaitingTime(callback.waitingMinutes)}
                        className={classes.waitingChip}
                        color={callback.waitingMinutes > 10 ? "secondary" : "default"}
                      />
                    </>
                  }
                  secondary={callback.callbackReason || "Sem motivo informado"}
                />
                <ListItemSecondaryAction>
                  <IconButton 
                    color="primary"
                    onClick={() => handleInitiateCallback(callback.id)}
                    disabled={loading}
                  >
                    <PhoneIcon />
                  </IconButton>
                </ListItemSecondaryAction>
              </ListItem>
            ))}
          </List>
        </DialogContent>
        <DialogActions>
          <Button onClick={() => setDialogOpen(false)}>Fechar</Button>
        </DialogActions>
      </Dialog>
    </>
  );
};

export default CallbackAlertWidget;
```

#### 9. FreeSWITCH Click-to-Call Service
```typescript
// backend/src/services/VoiceServices/FreeSwitchService.ts

import logger from "../../utils/logger";

/**
 * FreeSwitchService
 * 
 * Interage com FreeSWITCH via ESL para:
 * - Verificar disponibilidade de ramais
 * - Originar chamadas (click-to-call)
 * - Monitorar status de chamadas
 */

const ESL_HOST = process.env.ESL_HOST || "127.0.0.1";
const ESL_PORT = parseInt(process.env.ESL_PORT || "8021");
const ESL_PASSWORD = process.env.ESL_PASSWORD || "ClueCon";

class FreeSwitchService {
  
  /**
   * Verifica se um ramal est√° dispon√≠vel para receber chamadas
   */
  async checkExtensionAvailable(
    extension: string, 
    companyId: number
  ): Promise<boolean> {
    try {
      // TODO: Implementar conex√£o ESL real
      // Por enquanto, simular com HTTP API se dispon√≠vel
      
      // Comando ESL: sofia status profile internal reg <extension>
      // ou: show channels like <extension>
      
      // Retorna true se:
      // 1. Ramal registrado
      // 2. N√£o em chamada ativa
      
      return true; // Placeholder
    } catch (error) {
      logger.error("Error checking extension availability", { extension, error });
      return false;
    }
  }
  
  /**
   * Origina uma chamada de callback
   * 
   * Flow:
   * 1. Liga para o ramal do atendente
   * 2. Quando atender, toca mensagem de contexto
   * 3. Disca para o cliente
   * 4. Faz bridge entre os dois
   */
  async originateCallback({
    agentExtension,
    clientNumber,
    callbackReason,
    ticketId,
    companyId,
    domainName
  }: {
    agentExtension: string;
    clientNumber: string;
    callbackReason?: string;
    ticketId: number;
    companyId: number;
    domainName: string;
  }): Promise<{ success: boolean; callUuid?: string; error?: string }> {
    try {
      // Comando ESL originate:
      // originate {origination_caller_id_name='Callback',
      //            origination_caller_id_number='Callback',
      //            ticket_id=123}
      //   user/${agentExtension}@${domain}
      //   &bridge(sofia/gateway/trunk/${clientNumber})
      
      // Com √°udio de contexto:
      // originate ... &playback(callback_intro.wav)
      //   &bridge(sofia/gateway/trunk/${clientNumber})
      
      const callUuid = `callback-${Date.now()}-${ticketId}`;
      
      // TODO: Implementar ESL real
      logger.info("üìû Callback originated", {
        agentExtension,
        clientNumber,
        callUuid,
        ticketId
      });
      
      return { success: true, callUuid };
    } catch (error) {
      logger.error("Error originating callback", { error });
      return { 
        success: false, 
        error: error instanceof Error ? error.message : String(error) 
      };
    }
  }
}

export default new FreeSwitchService();
```

#### 10. Integra√ß√£o WhatsApp para Confirma√ß√£o
```typescript
// backend/src/services/VoiceServices/CallbackWhatsAppService.ts

import logger from "../../utils/logger";
import SendWABAMessageService from "../WABA/SendWABAMessageService";
import Ticket from "../../models/Ticket";

/**
 * Envia mensagem de confirma√ß√£o/notifica√ß√£o de callback via WhatsApp
 */

interface CallbackWhatsAppOptions {
  ticketId: number;
  phoneNumber: string;
  companyId: number;
  type: 'confirmation' | 'ready' | 'failed';
  agentName?: string;
  department?: string;
  reason?: string;
  scheduledTime?: string;
}

class CallbackWhatsAppService {
  
  async sendNotification(options: CallbackWhatsAppOptions): Promise<boolean> {
    const { type, phoneNumber, agentName, department, reason } = options;
    
    let message = "";
    let buttons: Array<{ id: string; title: string }> = [];
    
    switch (type) {
      case 'confirmation':
        message = `Ol√°! Aqui √© da Internet Play. üìû\n\n` +
          `Seu pedido de callback foi registrado!\n\n` +
          `üë§ Atendente: ${agentName || department || 'Pr√≥ximo dispon√≠vel'}\n` +
          (reason ? `üìù Assunto: ${reason}\n` : '') +
          `\nVamos retornar assim que poss√≠vel. Obrigado!`;
        break;
        
      case 'ready':
        message = `Ol√°! Aqui √© da Internet Play. üìû\n\n` +
          `${agentName || 'Nosso atendente'} est√° pronto para retornar sua liga√ß√£o` +
          (reason ? ` sobre "${reason}"` : '') + `.\n\n` +
          `Podemos ligar agora?`;
        buttons = [
          { id: 'callback_yes', title: '‚úÖ Sim, podem ligar' },
          { id: 'callback_later', title: '‚è∞ Depois' },
          { id: 'callback_cancel', title: '‚ùå N√£o precisa' }
        ];
        break;
        
      case 'failed':
        message = `Ol√°! Aqui √© da Internet Play. üìû\n\n` +
          `Tentamos retornar sua liga√ß√£o mas n√£o conseguimos contato.\n\n` +
          `Por favor, entre em contato conosco quando puder.\n` +
          `üìû Telefone: 0800 XXX XXXX\n` +
          `üí¨ WhatsApp: Este n√∫mero`;
        break;
    }
    
    try {
      // Usar SendWABAMessageService para enviar
      // await SendWABAMessageService({...})
      
      logger.info("üì± Callback WhatsApp sent", {
        ticketId: options.ticketId,
        phoneNumber,
        type
      });
      
      return true;
    } catch (error) {
      logger.error("Error sending callback WhatsApp", { error });
      return false;
    }
  }
  
  /**
   * Processa resposta do cliente √† notifica√ß√£o de callback
   */
  async processResponse(
    ticketId: number, 
    response: 'callback_yes' | 'callback_later' | 'callback_cancel'
  ): Promise<void> {
    const ticket = await Ticket.findByPk(ticketId);
    if (!ticket) return;
    
    switch (response) {
      case 'callback_yes':
        // Iniciar callback imediatamente
        await ticket.update({ callbackStatus: 'pending' });
        // O worker vai pegar e notificar o atendente
        break;
        
      case 'callback_later':
        // Perguntar hor√°rio via WhatsApp
        // ou adiar por 30 minutos
        await ticket.update({ 
          callbackScheduledAt: new Date(Date.now() + 30 * 60 * 1000) 
        });
        break;
        
      case 'callback_cancel':
        await ticket.update({ 
          callbackStatus: 'canceled',
          status: 'closed' 
        });
        break;
    }
  }
}

export default new CallbackWhatsAppService();
```

## Escopo

### FASE 1: Transfer√™ncia Inteligente (MVP)
- [x] Tabela de destinos de transfer√™ncia (FusionPBX)
- [x] L√≥gica de attended transfer via ESL
- [x] Detec√ß√£o de resultado (atendeu/ocupado/timeout)
- [x] Retorno ao agente IA com status
- [x] Mensagens contextuais ao cliente
- [x] Cria√ß√£o de ticket/recado com √°udio
- [x] Interface FusionPBX para gerenciamento
- [x] Grava√ß√£o de chamada completa

### FASE 2: Sistema de Callback (NOVO)
- [x] Model Ticket com campos de callback
- [x] M√°quina de estados para fluxo de callback
- [x] Captura inteligente de n√∫mero ("este mesmo")
- [x] Captura de hor√°rio preferido
- [x] Captura de assunto/motivo
- [x] Worker de monitoramento de callbacks
- [x] Detec√ß√£o de disponibilidade via ESL
- [x] Notifica√ß√£o via Socket.IO para atendente

### FASE 3: UI de Callback no OmniPlay
- [x] Widget de alertas de callback (FAB + Snackbar)
- [x] Lista de callbacks pendentes
- [x] Bot√£o "Ligar Agora" (click-to-call)
- [x] Bot√£o "Adiar" (snooze 5min)
- [x] Bot√£o "Dispensar"
- [x] Som de notifica√ß√£o
- [x] Badge com contador
- [x] Exibi√ß√£o do √°udio/transcri√ß√£o

### FASE 4: Click-to-Call
- [x] API POST /voice/callback/initiate
- [x] FreeSwitchService.originateCallback()
- [x] Bridge atendente ‚Üî cliente
- [x] √Åudio de contexto antes do bridge
- [x] Webhook de resultado

### FASE 5: Integra√ß√£o WhatsApp (Opcional)
- [ ] Confirma√ß√£o de callback agendado
- [ ] Notifica√ß√£o "pronto para ligar"
- [ ] Bot√µes interativos (Sim/Depois/Cancelar)
- [ ] Processamento de respostas
- [ ] Notifica√ß√£o de falha

### FASE 6: Melhorias Futuras
- [ ] Integra√ß√£o com sistema de presen√ßa BLF
- [ ] Prioriza√ß√£o por SLA/VIP
- [ ] Dashboard de m√©tricas de callback
- [ ] M√∫ltiplas tentativas autom√°ticas
- [ ] Previs√£o de tempo de espera por ML

## Riscos e Mitiga√ß√µes

| Risco | Probabilidade | Impacto | Mitiga√ß√£o |
|-------|---------------|---------|-----------|
| FreeSWITCH n√£o suportar attended transfer via ESL | Baixa | Alto | Usar bridge com monitoramento de eventos |
| Lat√™ncia na detec√ß√£o de ocupado | M√©dia | M√©dio | Usar SIP response codes diretamente |
| Grava√ß√£o n√£o iniciar antes do handoff | M√©dia | Alto | Iniciar grava√ß√£o no atendimento da chamada |
| Socket.IO n√£o entregar notifica√ß√£o | M√©dia | Alto | Polling como fallback + persist√™ncia no banco |
| Cliente n√£o atender callback | Alta | M√©dio | M√∫ltiplas tentativas + notifica√ß√£o WhatsApp |
| Atendente ignorar alerta | M√©dia | M√©dio | Escala√ß√£o autom√°tica + m√©tricas de SLA |

## Depend√™ncias

- FreeSWITCH com mod_commands e mod_dptools
- ESL (Event Socket Library) configurado
- MinIO para armazenamento de grava√ß√µes
- OmniPlay backend com VoiceHandoffService
- Socket.IO para notifica√ß√µes real-time
- BullMQ para jobs de monitoramento
- (Opcional) WhatsApp Business API para notifica√ß√µes

## M√©tricas de Sucesso

### Transfer√™ncia
1. **Taxa de transfer√™ncia bem-sucedida** > 70%
2. **Tempo m√©dio de espera para transfer** < 30 segundos
3. **Taxa de fallback para ticket/callback** < 30%

### Callback
4. **Taxa de callback atendido** > 80%
5. **Tempo m√©dio de retorno** < 15 minutos
6. **Taxa de abandono (cliente cancela)** < 10%
7. **NPS de clientes atendidos via callback** > 8

### Operacional
8. **Tempo m√©dio de resposta do atendente ao alerta** < 60 segundos
9. **Taxa de callbacks expirados (max tentativas)** < 5%

## Estimativa de Esfor√ßo

| Fase | Esfor√ßo | Prioridade |
|------|---------|------------|
| FASE 1: Transfer√™ncia Inteligente | 3-4 dias | üî¥ Alta |
| FASE 2: Sistema de Callback | 2-3 dias | üî¥ Alta |
| FASE 3: UI de Callback | 2-3 dias | üü° M√©dia |
| FASE 4: Click-to-Call | 1-2 dias | üü° M√©dia |
| FASE 5: WhatsApp Integration | 1-2 dias | üü¢ Baixa |
| **TOTAL** | **9-14 dias** | |

---

## ‚ö†Ô∏è REVIS√ÉO CR√çTICA - PROBLEMAS E ALTERNATIVAS

Esta se√ß√£o identifica problemas de l√≥gica e funcionalidades que seriam dif√≠ceis/imposs√≠veis de implementar com a arquitetura atual, propondo alternativas realistas.

---

### üî¥ PROBLEMA 1: ESL do OmniPlay Backend

**Proposta Original:**
> Worker de monitoramento (BullMQ no OmniPlay) verifica disponibilidade de ramais via FreeSWITCH ESL

**Por que √© IMPOSS√çVEL:**
- OmniPlay backend (Node.js) roda em container/servidor separado
- FreeSWITCH/FusionPBX est√° em outro servidor
- N√£o existe biblioteca ESL para Node.js bem mantida e confi√°vel
- Conex√µes ESL persistentes de outro container s√£o inst√°veis

**ALTERNATIVA VI√ÅVEL:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ARQUITETURA CORRIGIDA: PROXY VIA VOICE AI                                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ  OmniPlay          Voice AI (Python)        FreeSWITCH                      ‚îÇ
‚îÇ  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ         ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ        ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                      ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  [Worker]  ‚îÄ‚îÄHTTP‚îÄ‚îÄ‚ñ∫ [/api/extension/status] ‚îÄ‚îÄESL‚îÄ‚îÄ‚ñ∫ sofia status          ‚îÇ
‚îÇ            ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  {available: true}      ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  response              ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îÇ  [Click-to-Call] ‚îÄ‚îÄ‚ñ∫ [/api/callback/originate] ‚îÄ‚îÄESL‚îÄ‚îÄ‚ñ∫ originate           ‚îÇ
‚îÇ                 ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ {callUuid: "xxx"}       ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ call started          ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**IMPLEMENTA√á√ÉO:**
```python
# voice-ai-service/api/extension_routes.py

from enum import Enum

class ExtensionStatus(str, Enum):
    AVAILABLE = "available"       # Registrado, n√£o em chamada, sem DND
    IN_CALL = "in_call"          # Em chamada ativa
    DND = "dnd"                  # Do Not Disturb ativado
    OFFLINE = "offline"          # N√£o registrado
    RINGING = "ringing"          # Recebendo chamada (n√£o dispon√≠vel)
    UNKNOWN = "unknown"          # N√£o foi poss√≠vel determinar

@router.get("/extension/status/{extension}")
async def check_extension_status(extension: str, domain_uuid: str):
    """
    Verifica status completo do ramal:
    1. Registrado? (sofia status)
    2. Em chamada? (show channels)
    3. DND ativado? (db show dnd)
    4. Recebendo chamada? (show calls)
    """
    esl = await get_esl_connection()
    
    # 1. Verificar registro
    reg_result = await esl.send(f"sofia status profile internal reg {extension}@{domain}")
    is_registered = "Registered" in reg_result
    
    if not is_registered:
        return {
            "extension": extension,
            "status": ExtensionStatus.OFFLINE,
            "available": False,
            "reason": "Ramal n√£o registrado"
        }
    
    # 2. Verificar DND (Do Not Disturb)
    # FusionPBX armazena DND no banco de dados
    dnd_result = await check_dnd_database(extension, domain_uuid)
    if dnd_result:
        return {
            "extension": extension,
            "status": ExtensionStatus.DND,
            "available": False,
            "reason": "Modo n√£o perturbe ativado"
        }
    
    # 3. Verificar se em chamada ativa
    channels = await esl.send(f"show channels like {extension}")
    if extension in channels:
        # Verificar se est√° tocando ou j√° atendeu
        if "CS_RING" in channels or "CS_ROUTING" in channels:
            return {
                "extension": extension,
                "status": ExtensionStatus.RINGING,
                "available": False,
                "reason": "Recebendo chamada"
            }
        return {
            "extension": extension,
            "status": ExtensionStatus.IN_CALL,
            "available": False,
            "reason": "Em chamada ativa"
        }
    
    # 4. Dispon√≠vel!
    return {
        "extension": extension,
        "status": ExtensionStatus.AVAILABLE,
        "available": True,
        "reason": None
    }

async def check_dnd_database(extension: str, domain_uuid: str) -> bool:
    """Verifica DND no banco de dados do FusionPBX."""
    # FusionPBX armazena DND em v_extensions ou v_extension_settings
    query = """
        SELECT do_not_disturb 
        FROM v_extensions 
        WHERE extension = $1 AND domain_uuid = $2
    """
    result = await db.fetchone(query, extension, domain_uuid)
    return result and result.get("do_not_disturb") == "true"
```

---

### üî¥ PROBLEMA 2: Attended Transfer com Retorno ao Agente IA

**Proposta Original:**
> FreeSWITCH faz attended transfer; se falhar, agente IA retoma conversa

**Por que √© COMPLEXO:**
1. Durante attended transfer, a leg original √© colocada em **HOLD**
2. O cliente ouve **m√∫sica de espera**, n√£o o agente IA
3. O WebSocket do Voice AI precisa ser **mantido ativo** durante hold
4. Se transfer falhar, como **reconectar** o √°udio de volta ao Voice AI?

**OP√á√ïES:**

| Op√ß√£o | Descri√ß√£o | Complexidade | Recomenda√ß√£o |
|-------|-----------|--------------|--------------|
| A | Attended Transfer Real | üî¥ ALTA | ‚ùå N√£o recomendado |
| B | Blind Transfer com Fallback | üü° M√âDIA | ‚ö†Ô∏è Parcial |
| C | Hold + Polling + Reconnect | üü° M√âDIA | ‚úÖ Recomendado |
| D | **Callback (j√° proposto)** | üü¢ BAIXA | ‚úÖ **MELHOR** |

**ALTERNATIVA RECOMENDADA - Op√ß√£o C (Hold + Polling):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FLUXO CORRIGIDO: HOLD COM RECONEX√ÉO                                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ  1. Cliente pede atendente                                                  ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  2. Agente IA: "Um momento..."                                              ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  3. Voice AI envia comando ESL: uuid_hold {uuid} + uuid_transfer            ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  4. Cliente ouve m√∫sica de espera                                           ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  5. Voice AI MONITORA o resultado via ESL events:                           ‚îÇ
‚îÇ     - CHANNEL_BRIDGE: transfer OK ‚Üí encerrar sess√£o IA                      ‚îÇ
‚îÇ     - CHANNEL_HANGUP: ramal n√£o atendeu ‚Üí reativar conversa                 ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  6. Se falhou: uuid_unhold + reconectar √°udio ao Voice AI                   ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  7. Agente IA: "O ramal n√£o atendeu. Quer deixar recado?"                   ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**DESAFIO REMANESCENTE:**
- `uuid_unhold` s√≥ funciona se a chamada ainda estiver ativa
- Se o cliente desligar durante o hold, perdemos a oportunidade

**MITIGA√á√ÉO:**
- Timeout de 30 segundos para transfer
- Informar tempo estimado ao cliente: "Aguarde um momento, em at√© 30 segundos volto com voc√™"

---

### üî¥ PROBLEMA 3: Mensagem TTS Din√¢mica para Atendente

**Proposta Original:**
> Sistema toca: "Callback para cliente 18 99775-1234. Assunto: boleto vencido."

**Por que √© DIF√çCIL:**
- FreeSWITCH n√£o tem TTS nativo
- Precisaria de integra√ß√£o com Google TTS/Amazon Polly via mod_shout ou script
- Lat√™ncia adicional de 1-2 segundos para gerar √°udio

**ALTERNATIVAS:**

| Op√ß√£o | Descri√ß√£o | Complexidade |
|-------|-----------|--------------|
| A | TTS via Google Cloud (Lua script) | üü° M√©dia |
| B | Popup no softphone (se houver API) | üî¥ Alta |
| C | **WhatsApp/SMS antes de conectar** | üü¢ Baixa |
| D | **Tela do OmniPlay (j√° aberta)** | üü¢ Baixa |
| E | √Åudio gen√©rico + n√∫mero apenas | üü¢ Muito Baixa |

**ALTERNATIVA RECOMENDADA - Op√ß√£o D + E:**
```
1. Atendente j√° v√™ o alerta no OmniPlay com todos os detalhes
2. Ao clicar "Ligar Agora", apenas um beep ou "Conectando cliente..."
3. O atendente j√° sabe quem √© e o assunto
```

**SE QUISER TTS (Op√ß√£o A):**
```lua
-- freeswitch/scripts/callback_tts.lua
local number = session:getVariable("callback_number")
local reason = session:getVariable("callback_reason") or ""

-- Google TTS via shout
local tts_url = "shout://translate.google.com/translate_tts?ie=UTF-8&tl=pt-BR&q=" 
              .. "Callback%20para%20" .. number
              
session:execute("playback", tts_url)
```

---

### üî¥ PROBLEMA 4: Mapeamento user_id ‚Üî extension

**Proposta Original:**
> `callbackIntendedFor = user_id (Jeni)`

**PROBLEMA DE L√ìGICA:**
- OmniPlay conhece `user_id` (atendente)
- FreeSWITCH conhece `extension` (ramal)
- Um usu√°rio pode ter m√∫ltiplos ramais (celular, desktop, etc.)
- Um ramal pode ser compartilhado

**PERGUNTA:** Como saber qual ramal ligar?

**ALTERNATIVA - Usar Extension Diretamente:**
```typescript
// Ao inv√©s de armazenar user_id, armazenar extension
callbackExtension: "1004",           // Ramal principal
callbackExtensionFallback: "1005",   // Ramal alternativo (opcional)

// Se precisar de user_id, fazer JOIN com tabela de mapeamento
// FusionPBX j√° tem: v_extensions (extension, user_uuid)
```

**OU - Tabela de Mapeamento OmniPlay:**
```sql
-- Nova tabela: user_extensions
CREATE TABLE user_extensions (
    user_id INT REFERENCES Users(id),
    extension VARCHAR(10),
    domain_name VARCHAR(100),
    priority INT DEFAULT 1,  -- 1 = principal, 2 = fallback
    PRIMARY KEY (user_id, extension)
);
```

---

### üî¥ PROBLEMA 5: Defini√ß√£o de "Dispon√≠vel"

**PERGUNTA CR√çTICA:** O que significa ramal dispon√≠vel?

| Fonte | Informa√ß√£o | Confiabilidade |
|-------|------------|----------------|
| FreeSWITCH sofia status | Ramal registrado | ‚úÖ Alta |
| FreeSWITCH show channels | Em chamada ativa | ‚úÖ Alta |
| FusionPBX device status | DND, forwarding | ‚úÖ M√©dia |
| OmniPlay User.online | Agente logado | ‚úÖ Alta |
| OmniPlay User.status | available/away/busy | ‚úÖ Alta |

**PROBLEMA:**
- Ramal pode estar registrado mas agente "Away" no OmniPlay
- Agente pode estar "Online" mas telefone desligado
- Precisamos CRUZAR informa√ß√µes

**ALTERNATIVA - Verifica√ß√£o em Camadas:**
```typescript
async function isAgentAvailable(userId: number, extension: string): Promise<boolean> {
    // 1. Verificar status OmniPlay
    const user = await User.findByPk(userId);
    if (!user?.online || user.status !== 'available') {
        return false;
    }
    
    // 2. Verificar FreeSWITCH via Voice AI API
    const fsStatus = await voiceAiApi.get(`/extension/status/${extension}`);
    if (!fsStatus.data.registered || fsStatus.data.in_call) {
        return false;
    }
    
    return true;
}
```

---

### üî¥ PROBLEMA 6: WhatsApp Bot√µes Interativos (Janela 24h)

**Proposta Original:**
> Enviar mensagem com bot√µes: [Sim, podem ligar] [Depois] [N√£o precisa]

**PROBLEMA:**
- WABA s√≥ permite bot√µes interativos **dentro da janela de 24h**
- Se cliente ligou h√° mais de 24h, precisamos de **template aprovado**
- Templates n√£o suportam bot√µes din√¢micos da mesma forma

**ALTERNATIVA:**

```typescript
async function sendCallbackNotification(phoneNumber: string, options: any) {
    // Verificar se h√° conversa ativa (janela 24h)
    const ticket = await Ticket.findOne({
        where: { 
            contactNumber: phoneNumber, 
            status: { [Op.in]: ['open', 'pending'] },
            updatedAt: { [Op.gte]: new Date(Date.now() - 24 * 60 * 60 * 1000) }
        }
    });
    
    if (ticket) {
        // DENTRO da janela: pode usar bot√µes interativos
        return await sendInteractiveButtons(phoneNumber, options);
    } else {
        // FORA da janela: usar template ou texto simples
        return await sendTemplateMessage(phoneNumber, "callback_notification", {
            agent_name: options.agentName,
            reason: options.reason
        });
        // Template: "Ol√°! {{1}} est√° pronto para retornar sua liga√ß√£o sobre {{2}}. 
        //           Responda SIM para ligarmos agora, DEPOIS para adiar, ou N√ÉO se n√£o precisar mais."
    }
}
```

---

### üî¥ PROBLEMA 7: Race Condition no Click-to-Call

**CEN√ÅRIO:**
1. Worker detecta ramal dispon√≠vel (t=0)
2. Notifica atendente (t=0.5s)
3. Atendente v√™ alerta, pensa... (t=5s)
4. Outro atendente liga para o ramal (t=6s) ‚Üí OCUPADO
5. Atendente clica "Ligar Agora" (t=10s)
6. Sistema tenta originar ‚Üí **FALHA** (ramal ocupado)

**ALTERNATIVA - Double-Check + Retry:**
```typescript
async function initiateCallback(ticketId: number, userId: number) {
    const ticket = await Ticket.findByPk(ticketId);
    
    // 1. Re-verificar disponibilidade NO MOMENTO DO CLIQUE
    const isAvailable = await isAgentAvailable(userId, ticket.callbackExtension);
    
    if (!isAvailable) {
        // Ramal ficou ocupado entre notifica√ß√£o e clique
        return { 
            success: false, 
            error: "Ramal ocupado. Tente novamente em alguns segundos.",
            suggestSnooze: true
        };
    }
    
    // 2. Tentar originar
    const result = await originateCallback(ticket);
    
    if (!result.success && result.error === "BUSY") {
        // Race condition: ficou ocupado entre verifica√ß√£o e originate
        return { 
            success: false, 
            error: "Ramal ficou ocupado. Tentando novamente...",
            retrying: true
        };
        // Auto-retry em 30 segundos
    }
    
    return result;
}
```

---

### üî¥ PROBLEMA 8: Grava√ß√£o de Chamada (Acesso ao Storage)

**PROBLEMA:**
- Grava√ß√µes ficam no FusionPBX (`/var/lib/freeswitch/recordings/`)
- OmniPlay precisa acessar para anexar ao ticket
- Servidores diferentes, filesystems diferentes

**ALTERNATIVA - Upload Imediato:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FLUXO DE GRAVA√á√ÉO CORRIGIDO                                                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                             ‚îÇ
‚îÇ  1. Chamada encerra                                                         ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  2. FreeSWITCH salva grava√ß√£o localmente                                    ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  3. Lua script ou hangup_hook envia evento para Voice AI:                   ‚îÇ
‚îÇ     {call_uuid: "xxx", recording_path: "/path/to/file.wav"}                 ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  4. Voice AI:                                                               ‚îÇ
‚îÇ     a) L√™ arquivo via SSH/SCP do FusionPBX                                  ‚îÇ
‚îÇ     b) OU acessa storage compartilhado (NFS/S3)                             ‚îÇ
‚îÇ     c) Converte para MP3 (ffmpeg)                                           ‚îÇ
‚îÇ     d) Upload para MinIO                                                    ‚îÇ
‚îÇ     e) Notifica OmniPlay: POST /api/voice/recording/ready                   ‚îÇ
‚îÇ     ‚ñº                                                                       ‚îÇ
‚îÇ  5. OmniPlay recebe URL do MinIO e anexa ao ticket                          ‚îÇ
‚îÇ                                                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**REQUISITO:** Voice AI precisa acesso ao filesystem do FusionPBX (SSH ou NFS mount)

---

### üî¥ PROBLEMA 9: Multi-tenant Isolamento

**PROBLEMA:**
- FusionPBX usa `domain_uuid` para multi-tenant
- OmniPlay usa `companyId`
- Como garantir que um callback de Company A n√£o apare√ßa para Company B?

**J√Å TEMOS:** `omniplay_company_id` em `v_voice_secretaries`

**MAS FALTA:**
- Propagar `companyId` em TODAS as opera√ß√µes de callback
- Validar no frontend que callback pertence ao mesmo company
- Filtrar no worker por company

**ALTERNATIVA - Valida√ß√£o em Todas as Camadas:**
```typescript
// Worker
const pendingCallbacks = await Ticket.findAll({
    where: {
        ticketType: "callback",
        callbackStatus: "pending",
        companyId: companyId  // SEMPRE filtrar por company!
    }
});

// API
router.post("/callback/initiate", authMiddleware, async (req, res) => {
    const { ticketId } = req.body;
    const { companyId } = req.user;  // Do token JWT
    
    const ticket = await Ticket.findOne({
        where: { id: ticketId, companyId }  // Validar company!
    });
    
    if (!ticket) {
        return res.status(404).json({ error: "Ticket not found" });
    }
    // ...
});
```

---

## ‚úÖ RESUMO DAS ALTERNATIVAS VI√ÅVEIS

| Problema | Solu√ß√£o Original | Alternativa Vi√°vel |
|----------|------------------|-------------------|
| ESL do OmniPlay | Worker ESL direto | Proxy via Voice AI HTTP |
| Attended Transfer | FreeSWITCH nativo | Hold + Polling + Reconnect |
| TTS Din√¢mico | Google TTS no FreeSWITCH | Info j√° no alerta OmniPlay |
| user_id ‚Üî extension | Mapeamento autom√°tico | Armazenar extension diretamente |
| Disponibilidade | FreeSWITCH s√≥ | OmniPlay + FreeSWITCH combinados |
| WhatsApp bot√µes | Sempre interativo | Template fora da janela 24h |
| Race condition | Sem tratamento | Double-check + auto-retry |
| Grava√ß√£o | Acesso direto | Upload para MinIO via Voice AI |
| Multi-tenant | Assumido OK | Valida√ß√£o expl√≠cita em todas camadas |

---

## üìã ESCOPO REVISADO (Mais Realista)

### FASE 1: Transfer√™ncia B√°sica (MVP Simplificado)
- [ ] ~~Attended transfer com retorno~~ ‚Üí **Blind transfer com fallback para ticket**
- [x] Tabela de destinos de transfer√™ncia
- [x] Cria√ß√£o de ticket com √°udio quando transfer falha
- [ ] ~~Retorno ao agente IA~~ ‚Üí **Informar que vai criar ticket e desligar**

### FASE 2: Sistema de Callback (Ajustado)
- [x] API no Voice AI para verificar disponibilidade
- [x] Worker no OmniPlay que chama Voice AI HTTP
- [x] Captura inteligente de n√∫mero ("este mesmo")
- [x] Armazenar **extension** ao inv√©s de user_id

### FASE 3: UI de Callback (Mantido)
- [x] Widget de alertas
- [x] Double-check antes de iniciar callback
- [x] Tratamento de race condition com retry

### FASE 4: Click-to-Call (Via Proxy)
- [x] API no Voice AI para originar chamadas
- [x] OmniPlay chama Voice AI, n√£o ESL direto
- [ ] ~~TTS din√¢mico~~ ‚Üí Info no alerta OmniPlay

### FASE 5: WhatsApp (Ajustado)
- [x] Verificar janela 24h antes de enviar
- [x] Template para fora da janela
- [x] Bot√µes interativos apenas dentro da janela

---

## Pr√≥ximos Passos

1. ‚úÖ Aprovar este proposal REVISADO
2. üìù Criar design.md com arquitetura de proxy Voice AI
3. üìã Criar tasks.md com tarefas de implementa√ß√£o
4. üöÄ Implementar API de disponibilidade no Voice AI primeiro
5. üöÄ Implementar FASE 1 + 2 (MVP simplificado)
6. üß™ Testes internos com ramais
7. üöÄ Implementar FASE 3 + 4
8. üìä Coletar m√©tricas por 1 semana
9. üöÄ Implementar FASE 5 se m√©tricas positivas
