# =============================================================================
# Voice AI IVR - Configuração de Ambiente
# =============================================================================
#
# Copie este arquivo para .env e preencha os valores:
#   cp env.example .env
#   nano .env
#
# Documentação: docs/HYBRID_ARCHITECTURE.md
# =============================================================================

# =============================================================================
# DATABASE (FusionPBX PostgreSQL)
# =============================================================================
# O Voice AI acessa o banco do FusionPBX para ler configurações de secretárias,
# destinos de transferência, provedores de IA, etc.

DB_HOST=host.docker.internal
DB_PORT=5432
DB_NAME=fusionpbx
DB_USER=fusionpbx
DB_PASS=SUA_SENHA_POSTGRESQL_AQUI

# =============================================================================
# MODO DE ÁUDIO (IMPORTANTE!)
# =============================================================================
# Opções:
#
# 1. websocket (default):
#    - Áudio via mod_audio_stream (WebSocket porta 8085)
#    - Funciona bem com NAT
#    - Detecção de hangup quando WebSocket fecha
#    - Não suporta DTMF
#
# 2. dual (RECOMENDADO PARA PRODUÇÃO):
#    - Áudio via mod_audio_stream (WebSocket porta 8085)
#    - Eventos via ESL Outbound (TCP porta 8022)
#    - Detecção imediata de hangup via CHANNEL_HANGUP
#    - Suporte a DTMF
#    - Monitoramento completo de estado
#    - Melhor para diagnóstico
#
# 3. rtp (não recomendado):
#    - Áudio via RTP direto (UDP 10000-10100)
#    - Não funciona bem com NAT
#
# ⚠️ ATENÇÃO: Os modos "websocket" e "dual" REQUEREM o módulo mod_audio_stream
#    instalado no FreeSWITCH! Este módulo NÃO vem por padrão.
#    Instale de: https://github.com/amigniter/mod_audio_stream
#    Verifique com: fs_cli -x "module_exists mod_audio_stream"
#
# Ref: openspec/changes/dual-mode-esl-websocket/proposal.md

AUDIO_MODE=dual

# =============================================================================
# WEBSOCKET SERVER (Áudio)
# =============================================================================
# Servidor WebSocket que recebe áudio do mod_audio_stream
# Porta padrão: 8085

REALTIME_HOST=0.0.0.0
REALTIME_PORT=8085

# =============================================================================
# BARGE-IN (Interromper o agente quando o cliente falar)
# =============================================================================
# Para um comportamento mais natural (humano), o sistema pode detectar voz no
# áudio do FreeSWITCH e interromper imediatamente o TTS do agente.
#
# REALTIME_LOCAL_BARGE_RMS (default 1200)
# Threshold RMS mínimo para detectar fala do usuário e interromper o agente.
# - Valores mais altos = menos sensível (evita cortar com ruído/eco)
# - Recomendado: 1000-1500 para ambientes com eco
REALTIME_LOCAL_BARGE_RMS=1200
#
# REALTIME_LOCAL_BARGE_COOLDOWN (default 1.0s)
# Cooldown mínimo entre detecções para evitar cortes repetidos.
REALTIME_LOCAL_BARGE_COOLDOWN=1.0
#
# REALTIME_LOCAL_BARGE_CONSECUTIVE (default 15)
# Número de frames consecutivos acima do threshold para disparar interrupção.
# Cada frame = ~20ms, então 15 = ~300ms de fala sustentada.
# Valores mais altos = precisa falar por mais tempo para interromper.
REALTIME_LOCAL_BARGE_CONSECUTIVE=15

# Modo de playback para enviar áudio de volta ao FreeSWITCH:
#   - streamAudio: JSON com base64 (RECOMENDADO - formato documentado pelo mod_audio_stream)
#   - rawAudio: Header JSON + chunks binários (pode não funcionar em todas versões)
FS_PLAYBACK_MODE=streamAudio

# =============================================================================
# ESL INBOUND (Voice AI → FreeSWITCH)
# =============================================================================
# Conexão para ENVIAR comandos ao FreeSWITCH:
#   - uuid_transfer: Transferir chamadas
#   - uuid_broadcast: Tocar áudio
#   - originate: Originar chamadas (callback)
#   - uuid_hold: Colocar em espera
#
# Use host.docker.internal para acessar FreeSWITCH no host

ESL_HOST=host.docker.internal
ESL_PORT=8021
ESL_PASSWORD=ClueCon

# Timeouts (em segundos)
ESL_CONNECT_TIMEOUT=5.0
ESL_READ_TIMEOUT=30.0
ESL_RECONNECT_DELAY=2.0
ESL_MAX_RECONNECT_ATTEMPTS=3

# =============================================================================
# ESL OUTBOUND (FreeSWITCH → Voice AI)
# =============================================================================
# Servidor que RECEBE conexões do FreeSWITCH (dialplan: socket application)
# O FreeSWITCH conecta aqui quando uma chamada chega no ramal configurado
# Porta padrão: 8022

ESL_SERVER_HOST=0.0.0.0
ESL_SERVER_PORT=8022
ESL_MAX_CONNECTIONS=100

# =============================================================================
# REDIS (Cache e Rate Limiting)
# =============================================================================
# Redis é iniciado automaticamente pelo Docker Compose
# Use "redis" como hostname (nome do container)

REDIS_HOST=redis
REDIS_PORT=6379

# =============================================================================
# VOICE AI SERVICE (API HTTP)
# =============================================================================
# API REST para health checks, métricas, e operações administrativas

VOICE_AI_HOST=0.0.0.0
VOICE_AI_PORT=8100
VOICE_AI_REALTIME_PORT=8085

# =============================================================================
# PROVEDORES DE IA (Configure pelo menos um!)
# =============================================================================

# --------------------------------------------
# OpenAI Realtime (Recomendado para voz)
# --------------------------------------------
# Crie uma chave em: https://platform.openai.com/api-keys
# Modelo recomendado: gpt-realtime (GA) ou gpt-realtime-mini (menor custo)
OPENAI_API_KEY=sk-proj-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

# --------------------------------------------
# ElevenLabs (Vozes premium em português)
# --------------------------------------------
# Crie uma chave em: https://elevenlabs.io
# O Agent ID é obtido ao criar um "Conversational AI Agent"
ELEVENLABS_API_KEY=sk_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
ELEVENLABS_AGENT_ID=agent_XXXXXXXXXXXXXXXXXXXXXXXXXX

# --------------------------------------------
# Google Gemini (Alternativa econômica)
# --------------------------------------------
# Crie uma chave em: https://makersuite.google.com/app/apikey
GOOGLE_API_KEY=AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

# --------------------------------------------
# Groq (LLM muito rápido)
# --------------------------------------------
# Crie uma chave em: https://console.groq.com/keys
GROQ_API_KEY=

# =============================================================================
# LOGGING
# =============================================================================
# Níveis: DEBUG, INFO, WARNING, ERROR, CRITICAL

LOG_LEVEL=INFO

# Debug mode (mais logs, útil para desenvolvimento)
DEBUG=false

# =============================================================================
# DIRETÓRIOS
# =============================================================================
# Onde armazenar arquivos de áudio temporários e modelos

AUDIO_PATH=/var/lib/freeswitch/storage/voice-ai
MODELS_PATH=/opt/voice-ai/models

# =============================================================================
# MINIO (Storage de Arquivos)
# =============================================================================
# Compartilhado com OmniPlay para armazenar gravações

MINIO_ENDPOINT=storage.seudominio.com.br
MINIO_ACCESS_KEY=SEU_ACCESS_KEY
MINIO_SECRET_KEY=SEU_SECRET_KEY
MINIO_BUCKET=omniplay
MINIO_USE_SSL=true
MINIO_PUBLIC_URL=https://storage.seudominio.com.br

# =============================================================================
# INTEGRAÇÃO OMNIPLAY
# =============================================================================
# URL da API do OmniPlay para criar tickets, notificar atendentes, etc.

OMNIPLAY_API_URL=https://api.seudominio.com.br
VOICE_AI_SERVICE_TOKEN=SEU_TOKEN_DE_INTEGRACAO

# =============================================================================
# SISTEMA DE TRANSFER/HANDOFF
# =============================================================================
# Configurações para transferência de chamadas para atendentes humanos

# Timeout padrão para aguardar atendimento (segundos)
TRANSFER_DEFAULT_TIMEOUT=30

# Anunciar ao cliente antes de transferir ("Transferindo sua chamada...")
TRANSFER_ANNOUNCE_ENABLED=true

# Música de espera durante transferência
# Opções: local_stream://moh, silence_stream://1000, ou arquivo de áudio
TRANSFER_MUSIC_ON_HOLD=local_stream://moh

# =============================================================================
# SISTEMA DE CALLBACK
# =============================================================================
# Quando o atendente não está disponível, criar ticket para retornar

# Habilitar sistema de callback
CALLBACK_ENABLED=true

# Horas até o callback expirar e ser cancelado
CALLBACK_EXPIRATION_HOURS=24

# Máximo de notificações enviadas ao atendente
CALLBACK_MAX_NOTIFICATIONS=5

# Intervalo mínimo entre notificações (minutos)
CALLBACK_MIN_INTERVAL_MINUTES=10

# =============================================================================
# TIMEZONE
# =============================================================================
# Timezone para verificação de horário comercial

DEFAULT_TIMEZONE=America/Sao_Paulo

# Cache de condições de tempo (segundos)
TIME_CONDITION_CACHE_TTL=300

# =============================================================================
# LIMITES DE SESSÃO
# =============================================================================
# Proteção contra uso excessivo

# Máximo de sessões simultâneas por domínio
MAX_SESSIONS_PER_DOMAIN=10

# Timeout de inatividade (segundos) - encerra se cliente ficar em silêncio
SESSION_IDLE_TIMEOUT_SECONDS=30

# Duração máxima de uma sessão (segundos) - 10 minutos
SESSION_MAX_DURATION_SECONDS=600
